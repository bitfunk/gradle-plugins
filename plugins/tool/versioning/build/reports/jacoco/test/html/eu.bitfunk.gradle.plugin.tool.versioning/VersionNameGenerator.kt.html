<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>VersionNameGenerator.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">versioning</a> &gt; <a href="index.source.html" class="el_package">eu.bitfunk.gradle.plugin.tool.versioning</a> &gt; <span class="el_source">VersionNameGenerator.kt</span></div><h1>VersionNameGenerator.kt</h1><pre class="source lang-java linenums">/*
 * ISC License
 *
 * Copyright (c) 2022. Wolf-Martell Montw√© (bitfunk)
 *
 * Permission to use, copy, modify, and/or distribute this software for any
 * purpose with or without fee is hereby granted, provided that the above
 * copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
 * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
 * AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
 * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
 * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
 * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
 * PERFORMANCE OF THIS SOFTWARE.
 */

package eu.bitfunk.gradle.plugin.tool.versioning

import eu.bitfunk.gradle.plugin.tool.gitversion.GitVersionInfo
import eu.bitfunk.gradle.plugin.tool.gitversion.gitVersionInfo
import eu.bitfunk.gradle.plugin.tool.versioning.VersioningContract.Generator
import org.gradle.api.Project
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

<span class="fc" id="L29">internal class VersionNameGenerator(</span>
<span class="fc" id="L30">    private val project: Project,</span>
) : Generator {

    override fun generateVersionName(): String {
<span class="fc" id="L34">        val versionInfo = project.gitVersionInfo()</span>

<span class="fc" id="L36">        return when {</span>
<span class="fc bfc" id="L37" title="All 2 branches covered.">            versionInfo.branchName == UNDEFINED -&gt; versionNameWithQualifier(versionInfo)</span>
<span class="fc bfc" id="L38" title="All 2 branches covered.">            patternNoQualifierBranch.matches(versionInfo.branchName) -&gt; versionNameWithQualifier(versionInfo)</span>
<span class="fc bfc" id="L39" title="All 2 branches covered.">            patternFeatureBranch.matches(versionInfo.branchName) -&gt; versionNameFeature(versionInfo)</span>
<span class="fc bfc" id="L40" title="All 2 branches covered.">            patternDependabotBranch.matches(versionInfo.branchName) -&gt; versionNameDependabot(versionInfo)</span>
<span class="fc bfc" id="L41" title="All 2 branches covered.">            patternRenovateBranch.matches(versionInfo.branchName) -&gt; versionNameRenovate(versionInfo)</span>
<span class="fc" id="L42">            else -&gt; throw UnsupportedOperationException(&quot;branch name not supported: ${versionInfo.branchName}&quot;)</span>
        }
    }

    override fun generateVersionCode(): Int {
<span class="fc" id="L47">        val versionInfo = project.gitVersionInfo()</span>

<span class="fc" id="L49">        return versionInfo.versionCode * VERSION_CODE_SHIFT + versionInfo.commitDistance</span>
    }

    override fun generateFeatureVersionCode(date: Date): Int {
<span class="fc" id="L53">        val timestamp = SimpleDateFormat(&quot;MMddHHmm&quot;, Locale.ENGLISH).format(date)</span>
<span class="fc" id="L54">        return timestamp.toInt()</span>
    }

    override fun generateVersionDetails(): String {
<span class="fc" id="L58">        val versionInfo = project.gitVersionInfo()</span>

<span class="fc" id="L60">        return &quot;&quot;&quot;</span>
            VersionDetails(
<span class="fc" id="L62">               version = ${versionInfo.version}</span>
<span class="fc" id="L63">               versionCode = ${versionInfo.versionCode}</span>
<span class="fc" id="L64">               gitHash = ${versionInfo.gitHash}</span>
<span class="fc" id="L65">               gitHashFull = ${versionInfo.gitHashFull}</span>
<span class="fc" id="L66">               branchName = ${versionInfo.branchName}</span>
<span class="fc" id="L67">               commitDistance = ${versionInfo.commitDistance}</span>
<span class="fc" id="L68">               lastTag = ${versionInfo.lastTag}</span>
<span class="fc" id="L69">               isClean = ${versionInfo.isCleanTag}</span>
            )
<span class="fc" id="L71">        &quot;&quot;&quot;.trimIndent()</span>
    }

<span class="fc" id="L74">    private fun versionNameWithQualifier(versionInfo: GitVersionInfo, name: String = &quot;&quot;): String {</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        val version = if (!versionInfo.isCleanTag) {</span>
<span class="fc" id="L76">            var versionCleaned = versionInfo.version.substringBefore(&quot;.dirty&quot;)</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">            if (versionInfo.commitDistance &gt; 0) {</span>
<span class="fc" id="L78">                versionCleaned = versionCleaned.substringBefore(&quot;-&quot;)</span>
            }
<span class="fc bfc" id="L80" title="All 2 branches covered.">            if (name.isBlank()) {</span>
<span class="fc" id="L81">                &quot;$versionCleaned-SNAPSHOT&quot;</span>
            } else {
<span class="fc" id="L83">                &quot;$versionCleaned-$name-SNAPSHOT&quot;</span>
            }
        } else {
<span class="fc" id="L86">            versionInfo.version</span>
        }

<span class="fc bfc" id="L89" title="All 2 branches covered.">        return if (version.startsWith(&quot;v&quot;)) {</span>
<span class="fc" id="L90">            version.substring(1)</span>
        } else {
<span class="fc" id="L92">            version</span>
        }
    }

    private fun versionNameFeature(versionInfo: GitVersionInfo): String {
<span class="fc" id="L97">        var featureName = patternFeatureBranch.matchEntire(versionInfo.branchName)!!.groups[1]!!.value</span>

<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (patternIssueNumber.matches(featureName)) {</span>
<span class="fc" id="L100">            featureName = patternIssueNumber.matchEntire(featureName)!!.groups[1]!!.value</span>
        }

<span class="fc" id="L103">        return versionNameWithQualifier(versionInfo, featureName)</span>
    }

    private fun versionNameDependabot(versionInfo: GitVersionInfo): String {
<span class="fc" id="L107">        var dependabotName = patternDependabotBranch.matchEntire(versionInfo.branchName)!!.groups[1]!!.value</span>

<span class="fc" id="L109">        dependabotName = dependabotName</span>
<span class="fc" id="L110">            .replace(&quot;_&quot;, &quot;-&quot;)</span>
<span class="fc" id="L111">            .replace(&quot;/&quot;, &quot;-&quot;)</span>

<span class="fc" id="L113">        return versionNameWithQualifier(versionInfo, &quot;bump-$dependabotName&quot;)</span>
    }

    private fun versionNameRenovate(versionInfo: GitVersionInfo): String {
<span class="fc" id="L117">        var renovateName = patternRenovateBranch.matchEntire(versionInfo.branchName)!!.groups[1]!!.value</span>

<span class="fc" id="L119">        renovateName = renovateName</span>
<span class="fc" id="L120">            .replace(&quot;_&quot;, &quot;-&quot;)</span>
<span class="fc" id="L121">            .replace(&quot;/&quot;, &quot;-&quot;)</span>

<span class="pc bpc" id="L123" title="1 of 2 branches missed.">        if (renovateName == &quot;configure&quot;) {</span>
<span class="fc" id="L124">            renovateName = &quot;renovate-$renovateName&quot;</span>
        } else {
<span class="nc" id="L126">            renovateName = &quot;renovate-bump-$renovateName&quot;</span>
        }

<span class="fc" id="L129">        return versionNameWithQualifier(versionInfo, renovateName)</span>
    }

    private companion object {
<span class="pc" id="L133">        val patternNoQualifierBranch = &quot;main|release/.*&quot;.toRegex()</span>
<span class="pc" id="L134">        val patternFeatureBranch = &quot;feature/(.*)&quot;.toRegex()</span>
<span class="pc" id="L135">        val patternDependabotBranch = &quot;dependabot/(.*)&quot;.toRegex()</span>
<span class="pc" id="L136">        val patternRenovateBranch = &quot;renovate/(.*)&quot;.toRegex()</span>
<span class="pc" id="L137">        val patternIssueNumber = &quot;[A-Z]{2,8}-.*/(.*)&quot;.toRegex()</span>

        private const val UNDEFINED = &quot;unspecified&quot;
        const val VERSION_CODE_SHIFT = 100
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>